<%- include('../partials/header', { title: 'Admin Dashboard - SecureBank' }) %>

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="dashboard-title">
                        <i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard
                    </h1>
                    <p class="dashboard-subtitle">Welcome back, <%= user.name %>. Here's what's happening at SecureBank today.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="dashboard-actions">
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createAccountModal">
                            <i class="fas fa-plus me-2"></i>Create Account
                        </button>
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value"><%= stats.totalCustomers %></h3>
                        <p class="stat-label">Total Customers</p>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+<%= stats.newCustomersThisMonth %> this month</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value">₹<%= (stats.totalBalance / 100000).toFixed(1) %>L</h3>
                        <p class="stat-label">Total Deposits</p>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+12.5% vs last month</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value"><%= stats.totalTransactions %></h3>
                        <p class="stat-label">Total Transactions</p>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>+<%= stats.transactionsToday %> today</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value"><%= stats.pendingAccounts %></h3>
                        <p class="stat-label">Pending Approvals</p>
                        <% if (stats.pendingAccounts > 0) { %>
                            <div class="stat-change negative">
                                <i class="fas fa-clock"></i>
                                <span>Requires attention</span>
                            </div>
                        <% } else { %>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i>
                                <span>All caught up</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>Transaction Volume (Last 7 Days)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="transactionChart" height="100"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>Account Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="accountStatusChart" height="200"></canvas>
                        <div class="chart-legend mt-3">
                            <div class="legend-item">
                                <span class="legend-color bg-success"></span>
                                <span>Active (<%= stats.activeAccounts %>)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color bg-warning"></span>
                                <span>Pending (<%= stats.pendingAccounts %>)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color bg-danger"></span>
                                <span>Blocked (<%= stats.blockedAccounts %>)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Row -->
        <div class="row g-4">
            <!-- Recent Transactions -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clock me-2"></i>Recent Transactions</h5>
                        <a href="/admin/transactions" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View All
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <% if (recentTransactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Account</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% recentTransactions.forEach(transaction => { %>
                                            <tr>
                                                <td>
                                                    <span class="transaction-id"><%= transaction.transactionId %></span>
                                                </td>
                                                <td>
                                                    <% if (transaction.type === 'deposit') { %>
                                                        <span class="badge bg-success-subtle text-success">
                                                            <i class="fas fa-arrow-down me-1"></i>Deposit
                                                        </span>
                                                    <% } else if (transaction.type === 'withdrawal') { %>
                                                        <span class="badge bg-danger-subtle text-danger">
                                                            <i class="fas fa-arrow-up me-1"></i>Withdrawal
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge bg-primary-subtle text-primary">
                                                            <i class="fas fa-exchange-alt me-1"></i>Transfer
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <span class="amount <%= transaction.type === 'deposit' ? 'positive' : 'negative' %>">
                                                        ₹<%= transaction.amount.toLocaleString() %>
                                                    </span>
                                                </td>
                                                <td><%= transaction.accountId.accountNumber %></td>
                                                <td>
                                                    <span class="text-muted">
                                                        <%= new Date(transaction.createdAt).toLocaleDateString() %>
                                                        <%= new Date(transaction.createdAt).toLocaleTimeString() %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i><%= transaction.status %>
                                                    </span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h6>No recent transactions</h6>
                                <p class="text-muted">Transaction activity will appear here</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Pending Accounts -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clock me-2"></i>Pending Accounts</h5>
                        <a href="/admin/accounts?status=pending" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-eye me-1"></i>View All
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <% if (pendingAccounts.length > 0) { %>
                            <div class="pending-accounts-list">
                                <% pendingAccounts.forEach(account => { %>
                                    <div class="pending-account-item">
                                        <div class="account-info">
                                            <div class="account-avatar">
                                                <%= account.userId.name.charAt(0).toUpperCase() %>
                                            </div>
                                            <div>
                                                <h6 class="mb-1"><%= account.userId.name %></h6>
                                                <p class="mb-0 text-muted small">
                                                    <%= account.accountNumber %>
                                                </p>
                                                <p class="mb-0 text-muted small">
                                                    Applied: <%= new Date(account.createdAt).toLocaleDateString() %>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="account-actions">
                                            <button class="btn btn-sm btn-success me-1" 
                                                    onclick="updateAccountStatus('<%= account._id %>', 'active')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="updateAccountStatus('<%= account._id %>', 'blocked')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <h6>All caught up!</h6>
                                <p class="text-muted">No pending account approvals</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <a href="/admin/accounts" class="action-card">
                                    <div class="action-icon bg-primary">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <h6>Manage Accounts</h6>
                                        <p class="text-muted mb-0">View and manage customer accounts</p>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/admin/transactions" class="action-card">
                                    <div class="action-icon bg-success">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <div>
                                        <h6>View Transactions</h6>
                                        <p class="text-muted mb-0">Monitor all system transactions</p>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <button class="action-card" data-bs-toggle="modal" data-bs-target="#systemSettingsModal">
                                    <div class="action-icon bg-warning">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div>
                                        <h6>System Settings</h6>
                                        <p class="text-muted mb-0">Configure system parameters</p>
                                    </div>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="action-card" onclick="generateReport()">
                                    <div class="action-icon bg-info">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div>
                                        <h6>Generate Report</h6>
                                        <p class="text-muted mb-0">Create system reports</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Account Modal -->
<div class="modal fade" id="createAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle text-primary me-2"></i>Create New Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createAccountForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="customerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="initialBalance" class="form-label">Initial Balance</label>
                        <input type="number" class="form-control" id="initialBalance" min="1000" value="1000" required>
                        <small class="form-text text-muted">Minimum balance: ₹1,000</small>
                    </div>
                    <div class="mb-3">
                        <label for="accountType" class="form-label">Account Type</label>
                        <select class="form-select" id="accountType" required>
                            <option value="savings">Savings</option>
                            <option value="current">Current</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- System Settings Modal -->
<div class="modal fade" id="systemSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog text-warning me-2"></i>System Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Transaction Limits</h6>
                        <div class="mb-3">
                            <label class="form-label">Daily Transfer Limit</label>
                            <input type="number" class="form-control" value="100000" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Minimum Balance</label>
                            <input type="number" class="form-control" value="1000" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>System Status</h6>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                <label class="form-check-label" for="maintenanceMode">
                                    Maintenance Mode
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="newRegistrations" checked>
                                <label class="form-check-label" for="newRegistrations">
                                    Allow New Registrations
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning">
                    <i class="fas fa-save me-2"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Transaction Volume Chart
    const ctx1 = document.getElementById('transactionChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Transactions',
                data: [12, 19, 15, 25, 22, 18, 24],
                borderColor: 'rgb(37, 99, 235)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Account Status Chart
    const ctx2 = document.getElementById('accountStatusChart').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Active', 'Pending', 'Blocked'],
            datasets: [{
                data: [<%= stats.activeAccounts %>, <%= stats.pendingAccounts %>, <%= stats.blockedAccounts %>],
                backgroundColor: ['#059669', '#d97706', '#dc2626']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});

// Functions
function updateAccountStatus(accountId, status) {
    if (confirm(`Are you sure you want to ${status === 'active' ? 'approve' : 'block'} this account?`)) {
        fetch(`/admin/accounts/${accountId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

function refreshDashboard() {
    location.reload();
}

function generateReport() {
    window.open('/admin/reports/generate', '_blank');
}

// Create Account Form
document.getElementById('createAccountForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('customerName').value,
        email: document.getElementById('customerEmail').value,
        initialBalance: document.getElementById('initialBalance').value,
        accountType: document.getElementById('accountType').value
    };
    
    fetch('/admin/accounts/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Account created successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});
</script>

<%- include('../partials/footer') %>
